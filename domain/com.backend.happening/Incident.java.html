<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Incident.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">code-coverage</a> &gt; <a href="../index.html" class="el_bundle">domain</a> &gt; <a href="index.source.html" class="el_package">com.backend.happening</a> &gt; <span class="el_source">Incident.java</span></div><h1>Incident.java</h1><pre class="source lang-java linenums">package com.backend.happening;

import com.backend.shared.Location;
import com.backend.user.Comment;
import lombok.Builder;
import lombok.NonNull;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

/**
 * Represents a user-reported incident (e.g., traffic, danger, or other local issues).
 * Contains information about the incident's details, location, timing, and public feedback such as likes, dislikes, and comments.
 */
<span class="pc bpc" id="L16" title="4 of 8 branches missed.">@Builder(toBuilder = true)</span>
public record Incident(
<span class="pc bpc" id="L18" title="1 of 2 branches missed.">        @NonNull String title,</span>
<span class="pc bpc" id="L19" title="1 of 2 branches missed.">        @NonNull String description,</span>
<span class="pc bpc" id="L20" title="1 of 2 branches missed.">        @NonNull String authorUsername,</span>
<span class="pc bpc" id="L21" title="1 of 2 branches missed.">        @NonNull Location location,</span>
        LocalDateTime createdAt,
        LocalDateTime expirationTime,
        List&lt;Comment&gt; comments,
        int likes,
        int dislikes,
        int confirms,
        int denies,
        int consecutiveDenies
) implements Happening{

    /**
     * Constructs an {@code Incident} instance with input validation.
     *
     * @throws IllegalArgumentException if:
     *   @param title is shorter than 10 characters
     *   @param description is shorter than 20 characters
     *   Any reaction count is negative
     *   @param expirationTime is before @param createdAt or before current time
     */
<span class="fc" id="L41">    public Incident {</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">        if (title.length() &lt; 10)</span>
<span class="fc" id="L43">            throw new IllegalArgumentException(&quot;Title too short.&quot;);</span>

<span class="fc bfc" id="L45" title="All 2 branches covered.">        if (description.length() &lt; 20)</span>
<span class="fc" id="L46">            throw new IllegalArgumentException(&quot;Description too short.&quot;);</span>

<span class="pc bpc" id="L48" title="4 of 10 branches missed.">        if (likes &lt; 0 || dislikes &lt; 0 || confirms &lt; 0 || denies &lt; 0 || consecutiveDenies &lt; 0)</span>
<span class="fc" id="L49">            throw new IllegalArgumentException(&quot;Negative values not allowed.&quot;);</span>

<span class="pc bpc" id="L51" title="1 of 2 branches missed.">        if (createdAt == null)</span>
<span class="nc" id="L52">            createdAt = LocalDateTime.now();</span>

<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        if (expirationTime == null)</span>
<span class="nc" id="L55">            expirationTime = createdAt.plusMinutes(30);</span>

<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (expirationTime.isBefore(createdAt))</span>
<span class="fc" id="L58">            throw new IllegalArgumentException(&quot;Expiration time cannot be before createdAt.&quot;);</span>

<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (expirationTime.isBefore(LocalDateTime.now()))</span>
<span class="fc" id="L61">            throw new IllegalArgumentException(&quot;Expiration time cannot be before now.&quot;);</span>

<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        comments = comments == null ? List.of() : new ArrayList&lt;&gt;(comments);</span>
<span class="fc" id="L64">    }</span>

    /**
     * Checks whether the incident should be deleted.
     * An incident is deleted if it is expired or has at least 3 consecutive denies.
     *
     * @return {@code true} if the incident should be removed.
     */
    public boolean isDeleted() {
<span class="pc bpc" id="L73" title="1 of 4 branches missed.">            return consecutiveDenies &gt;=3 || isExpired();</span>
    }

    /**
     * Adds a confirmation to the incident.
     * This increases the confirmation count, extends the expiration time by 5 minutes,
     * and resets the consecutive denies counter.
     *
     * @return A new {@code Incident} instance with updated state.
     */
    public Incident addConfirm() {
<span class="fc" id="L84">        return this.toBuilder()</span>
<span class="fc" id="L85">                .confirms(confirms + 1)</span>
<span class="fc" id="L86">                .expirationTime(expirationTime.plusMinutes(5))</span>
<span class="fc" id="L87">                .consecutiveDenies(0)</span>
<span class="fc" id="L88">                .build();</span>
    }

    /**
     * Adds a denial to the incident.
     * This increases both the total and consecutive denial counters.
     *
     * @return A new {@code Incident} instance with updated denial counts.
     */
    public Incident addDeny() {
<span class="fc" id="L98">        return this.toBuilder()</span>
<span class="fc" id="L99">                .denies(denies + 1)</span>
<span class="fc" id="L100">                .consecutiveDenies(consecutiveDenies + 1)</span>
<span class="fc" id="L101">                .build();</span>
    }

    /**
     * Checks if the incident has expired based on the current time.
     *
     * @return {@code true} if the expiration time is in the past.
     */
    public boolean isExpired() {
<span class="fc" id="L110">        return LocalDateTime.now().isAfter(expirationTime);</span>
    }

    /**
     * Increments the like counter.
     *
     * @return A new {@code Incident} instance with one additional like.
     */
    @Override
    public Incident addLike() {
<span class="fc" id="L120">        return toBuilder()</span>
<span class="fc" id="L121">                .likes(likes + 1)</span>
<span class="fc" id="L122">                .build();</span>
    }

    /**
     * Decrements the like counter.
     *
     * @return A new {@code Incident} instance with one less like.
     */
    @Override
    public Incident removeLike() {
<span class="fc" id="L132">        return toBuilder()</span>
<span class="fc" id="L133">                .likes(likes - 1)</span>
<span class="fc" id="L134">                .build();</span>
    }

    /**
     * Increments the dislike counter.
     *
     * @return A new {@code Incident} instance with one additional dislike.
     */
    @Override
    public Incident addDislike() {
<span class="fc" id="L144">        return toBuilder()</span>
<span class="fc" id="L145">                .dislikes(dislikes + 1)</span>
<span class="fc" id="L146">                .build();</span>
    }

    /**
     * Decrements the dislike counter.
     *
     * @return A new {@code Incident} instance with one less dislike.
     */
    @Override
    public Incident removeDislike() {
<span class="fc" id="L156">        return toBuilder()</span>
<span class="fc" id="L157">                .dislikes(dislikes - 1)</span>
<span class="fc" id="L158">                .build();</span>
    }

    /**
     * Appends a new comment to the incident's comment list.
     *
     * @param comment The {@code Comment} to be added.
     * @return A new {@code Incident} instance with the added comment.
     */
    @Override
    public Incident addComment(Comment comment) {
<span class="fc" id="L169">        List&lt;Comment&gt; commentsCopy = new  ArrayList&lt;&gt;(comments());</span>
<span class="fc" id="L170">        commentsCopy.add(comment);</span>

<span class="fc" id="L172">        return toBuilder()</span>
<span class="fc" id="L173">                .comments(commentsCopy)</span>
<span class="fc" id="L174">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>